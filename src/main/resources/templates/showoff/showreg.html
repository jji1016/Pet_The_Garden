<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head ('ë°˜ë ¤ë™ë¬¼ ì¥ê¸°ìë‘ ë“±ë¡')}">
    <link rel="stylesheet" th:href="@{/css/showoff/showreg.css}">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="showreg-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="showreg-card">
                    <div class="showreg-header">
                        <h1 class="showreg-title">ë°˜ë ¤ë™ë¬¼ ì¥ê¸°ìë‘</h1>
                        <p class="showreg-subtitle">ìš°ë¦¬ ì•„ì´ì˜ íŠ¹ë³„í•œ ëª¨ìŠµì„ ìë‘í•´ì£¼ì„¸ìš”! ğŸ¾</p>
                    </div>

                    <div class="showreg-body">
                        <form th:action="@{/showoff/showreg}" method="post" th:object="${showRegDto}" enctype="multipart/form-data">
                            <div th:if="${error}" class="alert alert-danger" role="alert">
                                <span th:text="${error}"></span>
                            </div>
                            <div th:if="${message}" class="alert alert-success" role="alert">
                                <span th:text="${message}"></span>
                            </div>

                            <!-- ì œëª© ì…ë ¥ -->
                            <div class="form-group mb-4">
                                <label for="subject" class="form-label">ì œëª©</label>
                                <input type="text" id="subject" name="subject" th:field="*{subject}" class="form-control" placeholder="ì¥ê¸°ìë‘ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('subject')}" th:errors="*{subject}"></div>
                            </div>

                            <!-- í« ë¦¿ìŠ¤íŠ¸ ì„ íƒ -->
                            <div class="form-group mb-4">
                                <label for="listOfPet" class="form-label">ì œëª©</label>
                                <select id="listOfPet" name="petId" class="form-control" required>
                                    <th:block th:each="pet : ${listOfPet}">
                                        <option th:value="${pet.id}" th:text="${pet.petName}"></option>
                                    </th:block>
                                </select>
                            </div>

                            <!-- ë‚´ìš© ì…ë ¥ -->
                            <div class="form-group mb-4">
                                <label for="content" class="form-label">ë‚´ìš©</label>
                                <textarea id="content" name="content" th:field="*{content}" class="form-control" rows="8" placeholder="ìš°ë¦¬ ì•„ì´ì˜ íŠ¹ë³„í•œ ëª¨ìŠµì„ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”" required></textarea>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></div>
                            </div>

                            <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë¯¸ë¦¬ë³´ê¸° -->
                            <div class="form-group mb-4">
                                <label for="imageFile" class="form-label">ì´ë¯¸ì§€ ì²¨ë¶€</label>
                                <div class="image-upload-container">
                                    <input type="file" id="imageFile" name="imageFile" accept="image/*" class="form-control">
                                    <input type="hidden" id="image" name="image" th:field="*{image}">
                                    <div class="image-preview" id="imagePreview" style="display: none; margin-top: 10px;">
                                        <img id="previewImg" src="" alt="ë¯¸ë¦¬ë³´ê¸°" class="preview-image" style="max-width: 300px; max-height: 300px;">
                                        <button type="button" class="btn btn-sm btn-danger remove-image" style="margin-top: 10px;">ì‚­ì œ</button>
                                    </div>
                                </div>
                            </div>

                            <!-- ìœ íŠœë¸Œ ë§í¬ -->
                            <div class="form-group mb-4">
                                <label for="youtubeLink" class="form-label">ìœ íŠœë¸Œ ë§í¬</label>
                                <input type="url" id="youtubeLink" name="youtubeLink" th:field="*{youtubeLink}" class="form-control" placeholder="https://www.youtube.com/watch?v=...">
                                <small class="form-text text-muted">ìœ íŠœë¸Œ ë™ì˜ìƒ ë§í¬ë¥¼ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì„ë² ë“œë©ë‹ˆë‹¤.</small>
                                <div class="youtube-preview" id="youtubePreview" style="display: none;">
                                    <div class="youtube-embed-container">
                                        <iframe id="youtubeFrame" width="560" height="315" src="" frameborder="0" allowfullscreen></iframe>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group text-center">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-paw"></i> ì¥ê¸°ìë‘ ë“±ë¡í•˜ê¸°
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        const imageFile = document.getElementById('imageFile');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeBtn = document.querySelector('.remove-image');
        const imageInput = document.getElementById('image');

        if (imageFile) {
            imageFile.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);

                    // ì„œë²„ì— ì—…ë¡œë“œ
                    const formData = new FormData();
                    formData.append('image', file);
                    const imageContainer = document.querySelector('.image-upload-container');
                    imageContainer.classList.add('loading');
                    fetch('/showoff/upload-image', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            imageContainer.classList.remove('loading');
                            if (data.success) {
                                imageInput.value = data.url;
                            } else {
                                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
                                imageFile.value = '';
                                imagePreview.style.display = 'none';
                            }
                        })
                        .catch(error => {
                            imageContainer.classList.remove('loading');
                            alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            imageFile.value = '';
                            imagePreview.style.display = 'none';
                        });
                } else {
                    previewImg.src = '';
                    imagePreview.style.display = 'none';
                }
            });
        }

        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                imageFile.value = '';
                imageInput.value = '';
                previewImg.src = '';
                imagePreview.style.display = 'none';
            });
        }

        // ìœ íŠœë¸Œ ë¯¸ë¦¬ë³´ê¸°
        const youtubeLink = document.getElementById('youtubeLink');
        const youtubePreview = document.getElementById('youtubePreview');
        const youtubeFrame = document.getElementById('youtubeFrame');

        if (youtubeLink) {
            youtubeLink.addEventListener('input', function() {
                const url = youtubeLink.value.trim();
                const regExp = /^.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const match = url.match(regExp);
                if (match && match[1].length === 11) {
                    youtubeFrame.src = 'https://www.youtube.com/embed/' + match[1];
                    youtubePreview.style.display = 'block';
                } else {
                    youtubeFrame.src = '';
                    youtubePreview.style.display = 'none';
                }
            });
        }
    });
</script>
</body>
</html>
