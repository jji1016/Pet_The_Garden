<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <title>ë§ˆì´í˜ì´ì§€</title>
  <th:block th:replace="fragments/head :: head('ë§ˆì´í˜ì´ì§€')"></th:block>
  <link rel="stylesheet" href="/css/mypage/mypage.css" />
  <meta charset="UTF-8" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body>
<header th:replace="fragments/header :: headerFragment"></header>

<!-- â†“â†“â†“ ì´í•˜ ê¸°ì¡´ ë§ˆì´í˜ì´ì§€ ì½˜í…ì¸  ìœ ì§€ â†“â†“â†“ -->
<div id="section">
  <div class="my_top">
    <div class="top_left">
      <p>ì•ˆë…•í•˜ì„¸ìš”. <span id="userNameDisplay" th:text="${loggedMemberDto.userName}">ì•„ë¬´ê°œ</span>ë‹˜</p>
    </div>
  </div>

  <div class="my_list">
    <h1>ë§ˆì´í˜ì´ì§€</h1>
    <ul class="list1">
      <li data-tab="profile">ë‚´ ì •ë³´ ê´€ë¦¬</li>
      <li data-tab="talent">ë‚´ê°€ ì“°ëŠ” ì¥ê¸°ìë‘ ê¸€</li>
      <li data-tab="freeboard">ë‚´ê°€ ì“°ëŠ” ììœ ê²Œì‹œíŒ ê¸€</li>
      <li data-tab="pet">ë°˜ë ¤ë™ë¬¼ ë“±ë¡</li>
      <li data-tab="follow">íŒ”ë¡œìš°í•œ ë°˜ë ¤ë™ë¬¼</li>
      <li data-tab="qna">1:1 ë¬¸ì˜ë‚´ì—­</li>
    </ul>

    <div class="content_wrap">
      <!-- ë‚´ ì •ë³´ ê´€ë¦¬ -->
      <div class="content" id="profile" style="display: block;">
        <h2>ë‚´ ì •ë³´ ìˆ˜ì •</h2>
        <table class="personal_info">
          <tr><td>ì´ë¦„</td><td><input type="text" id="inputName" data-field="userName"></td></tr>
          <tr><td>ì´ë©”ì¼</td><td><input type="email" id="inputEmail" data-field="userEmail"></td></tr>
          <tr>
            <td>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</td>
            <td><input type="password" data-field="currentPassword"></td>
          </tr>
          <tr>
            <td>ìƒˆ ë¹„ë°€ë²ˆí˜¸</td>
            <td><input type="password" data-field="password"></td>
          </tr>
          <tr>
            <td>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</td>
            <td><input type="password" data-field="password2"></td>
          </tr>
          <tr>
            <td>ë°°ì†¡ì§€</td>
            <td>
              <input type="text" class="ad_num" id="zipcode" data-field="zipcode" readonly>
              <button type="button" class="ad_search" onclick="execDaumPostcode()">ì£¼ì†Œê²€ìƒ‰</button><br>
              <input type="text" class="address" id="address01" data-field="address01" readonly><br>
              <input type="text" class="address" id="address02" data-field="address02">
            </td>
          </tr>
          <tr>
            <td>íœ´ëŒ€ì „í™”</td>
            <td>
              <select class="p_num_s" id="tel1" data-field="tel1">
                <option value="010">010</option>
                <option value="011">011</option>
              </select>
              -
              <input type="text" maxlength="4" class="p_num" id="tel2" data-field="tel2">
              -
              <input type="text" maxlength="4" class="p_num" id="tel3" data-field="tel3">
            </td>
          </tr>

          <!-- ì£¼ì†Œ, ì „í™”ë²ˆí˜¸ ë“± í•„ìš”í•œ í•­ëª© ì¶”ê°€ ê°€ëŠ¥ -->
        </table>
        <span class="cus_edit2">íšŒì›íƒˆí‡´í•˜ê¸°</span>
        <div class="cus_btn">
        <button class="cus_edit" id="editBtn">ìˆ˜ì •í•˜ê¸°</button>
          </div>
      </div>

      <!-- ì¥ê¸°ìë‘ ê¸€ ë‚´ì—­ -->
      <div class="content">
        <h2>ë‚´ê°€ ì“´ ì¥ê¸°ìë‘ ê¸€</h2>
        <ul class="request_detail">
          <li class="detail_on">ì¥ê¸°ìë‘ ê¸€ ë‚´ì—­(<span id="number1">1</span>)</li>
        </ul>
        <table class="order_table">
          <thead>
          <tr>
            <th>ê¸€ì“´ë‚ ì§œ</th>
            <th>ì œëª©</th>
            <th>ì´ë¯¸ì§€</th>
            <th>í«ì´ë¦„</th>
          </tr>
          </thead>
          <tbody id="subscribeRap2">
          <!-- ê¸€ë‚´ì—­ ë“¤ì–´ê°€ëŠ” ìë¦¬ -->
          </tbody>
        </table>

        <table class="page_btn">
          <tbody>
          <tr id="subscribePagination2">

          </tr>
          </tbody>
        </table>
      </div>

      <!-- ë‚´ê°€ ì‘ì„±í•œ ê¸€ ë‚´ì—­ -->
      <div class="content" id="freeboard-tab" style="display:none;">
        <h2>ë‚´ê°€ ì“´ ììœ ê²Œì‹œíŒ ê¸€</h2>
        <ul class="request_detail">
          <li class="detail_on">ììœ ê²Œì‹œíŒ ê¸€ ë‚´ì—­(<span id="number1">1</span>)</li>
        </ul>
        <table class="order_table">
          <thead>
          <tr>
            <th>ê¸€ì“´ë‚ ì§œ</th>
            <th>ì œëª©</th>
          </tr>
          </thead>
          <tbody id="subscribeRap">
          <tr th:each="board : ${myBoards}">
            <td th:text="${#temporals.format(board.modifyDate != null ? board.modifyDate : board.regDate, 'yyyy-MM-dd HH:mm')}"></td>
            <td><a th:href="@{/community/boarddetail/{id}(id=${board.id})}" th:text="${board.subject}">ê²Œì‹œê¸€ ì œëª©</a></td>
          </tr>
          <tr th:if="${#lists.isEmpty(myBoards)}">
            <td colspan="3">ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td>
          </tr>
          </tbody>
        </table>

        <table class="page_btn">
          <tbody>
          <tr id="freeboard-pagination">
            <td th:if="${myBoardsPage.hasPrevious()}">
              <a th:href="@{/mypage/mypage(page=${myBoardsPage.number - 1}, tab='freeboard')}">ì´ì „</a>
            </td>

            <td th:each="pageNum : ${#numbers.sequence(0, myBoardsPage.totalPages - 1)}"
                th:classappend="${pageNum == myBoardsPage.number} ? 'current'">
              <a th:href="@{/mypage/mypage(page=${pageNum}, tab='freeboard')}" th:text="${pageNum + 1}">1</a>
            </td>

            <td th:if="${myBoardsPage.hasNext()}">
              <a th:href="@{/mypage/mypage(page=${myBoardsPage.number + 1}, tab='freeboard')}">ë‹¤ìŒ</a>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- ë°˜ë ¤ë™ë¬¼ ë“±ë¡ -->
      <div class="content" id="petreg">
        <h2>ë°˜ë ¤ë™ë¬¼ ë“±ë¡</h2>
        <ul class="request_detail">
          <li class="detail_on">ë°˜ë ¤ë™ë¬¼ ë“±ë¡ë‚´ì—­(<span id="number1">1</span>)</li>
        </ul>
        <table class="order_table">
          <thead>
          <tr>
            <th>ë°˜ë ¤ë™ë¬¼ ë“±ë¡ì¼</th>
            <th>ë°˜ë ¤ë™ë¬¼ ì´ë¦„</th>
            <th>í”„ë¡œí•„ ì´ë¯¸ì§€</th>
            <th>ë°˜ë ¤ë™ë¬¼ ì¢…</th>
            <th>
              <a href="/mypage/petreg" class="review-btn" style="display: inline-block; margin-top: 5px;">ë“±ë¡í•˜ê¸°</a>
            </th>
          </tr>
          </thead>
          <tbody id="subscribeRap">
          <tr th:each="pet : ${pets}">
            <td th:text="${#temporals.format(pet.modifyDate != null ? pet.modifyDate : pet.regDate, 'yyyy-MM-dd HH:mm')}">2025-07-07</td>
            <td th:text="${pet.petName}">ë°˜ë ¤ë™ë¬¼ ì´ë¦„</td>
            <td>
              <a th:href="@{/mypage/petdetail/{id}(id=${pet.id})}">
                <img th:src="@{'/PTGUpload/pet/' + ${pet.profileImg}}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" style="width: 50px; height: 50px; object-fit: cover;" />
              </a>
            </td>
            <td th:text="${pet.species}">ë°˜ë ¤ë™ë¬¼ ì¢…</td>
            <td>
            <form th:action="@{/mypage/petdelete/{id}(id=${pet.id})}" method="post" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
            <button type="submit" class="cancel_btn">ë“±ë¡ì·¨ì†Œ</button>
          </form></td>
          </tr>

          <!-- pets ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì—ˆì„ ë•Œ í‘œì‹œ -->
          <tr th:if="${pets == null or #lists.isEmpty(pets)}">
            <td colspan="4">
              <div class="no-pet content-inner">
                <p>ë“±ë¡ëœ ë°˜ë ¤ë™ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
            </td>
          </tr>
          </tbody>
        </table>

        <table class="page_btn">
          <tbody>
          <tr id="subscribePagination">
            <td><a href="#">1</a></td>
          </tr>
          </tbody>
        </table>
        <!--<table class="personal_info">
          <tr><td>ì´ë¦„</td><td><input type="text" id="petName" name="petName"></td></tr>
          <tr><td>ì¢…</td><td><input type="text" id="species" name="species"></td></tr>
          <tr>
            <td>ì„±ë³„</td>
            <td>
              <input type="radio" id="Male" name="petGender" value="MALE">
              <label for="Male">ìˆ˜ì»·</label>
              <input type="radio" id="Female" name="petGender" value="FEMALE">
              <label for="Female">ì•”ì»·</label>
            </td>
          </tr>
          <tr><td>ìƒë…„ì›”ì¼</td><td><input type="text" id="birthDate" name="birthDate"></td></tr>
          <tr><td>ì„±ê²©</td><td><input type="text" id="character" name="character"></td></tr>
          <tr><td>ì¢‹ì•„í•˜ëŠ” ê²ƒ</td><td><input type="text" id="petLike" name="petLike"></td></tr>
          <tr><td>ì‹«ì–´í•˜ëŠ” ê²ƒ</td><td><input type="text" id="petDisLike" name="petDisLike"></td></tr>
          <tr><td>ì†Œê°œ</td><td><textarea id="content" name="content"></textarea></td></tr>
          <tr><td>í”„ë¡œí•„ ì´ë¯¸ì§€</td><td><input type="file" id="profileImg" name="profileImg"></td></tr>
        </table>
        <button class="cus_edit" id="petSubmitBtn" style="border-radius: 40px;">ë“±ë¡í•˜ê¸°</button>-->
      </div>

      <!-- íŒ”ë¡œìš°í•œ ë°˜ë ¤ë™ë¬¼ ë‚´ì—­ -->
      <div class="content">
        <h2>íŒ”ë¡œìš°í•œ ë°˜ë ¤ë™ë¬¼ ë‚´ì—­</h2>
        <ul id="petFollowList">
          <li class="pet-card">
            <a href="/pet/profile/1">
              <img src="/images/sample_dog.jpg" alt="ë°˜ë ¤ë™ë¬¼ì‚¬ì§„">
              <p class="pet-name">ë©ë©ì´</p>
            </a>
            <button class="unfollow-btn" data-pet-id="1">íŒ”ë¡œìš° ì·¨ì†Œ</button>
          </li>
          <li class="pet-card">
            <a href="/pet/profile/2">
              <img src="/images/sample_cat.jpg" alt="ë°˜ë ¤ë™ë¬¼ì‚¬ì§„">
              <p class="pet-name">ì•¼ì˜¹ì´</p>
            </a>
            <button class="unfollow-btn" data-pet-id="1">íŒ”ë¡œìš° ì·¨ì†Œ</button>
          </li>
          <!-- ë”ë¯¸ ë°ì´í„° ë°˜ë³µ -->
        </ul>
      </div>
      <div class="content">
        <h2>1:1 ë¬¸ì˜ë‚´ì—­</h2>
        <div class="c_service">
          <h2>ê³ ê°ì„¼í„° 1661-0543</h2>
          <p>ìš´ì˜ì‹œê°„(ì£¼ë§, ê³µíœ´ì¼ íœ´ë¬´) 10:00 ~ 18:00 ì ì‹¬ì‹œê°„ 12:30 ~ 13:30</p>
          <ul class="c_service_txt">
            <li>- ìš´ì˜ ì‹œê°„ ë‚´ì—ëŠ” 2ì‹œê°„ ì´ë‚´ì— ë‹µë³€ì„ ë“œë¦¬ë‚˜, ë¬¸ì˜ê°€ ë§ì„ ë•Œì—ëŠ” ë‹¤ì†Œ ì§€ì—°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            <li>- ì‹¤ì‹œê°„ ì±„íŒ…ìƒë‹´ì„ í†µí•œ ë¬¸ì˜ ë‚´ì—­ì€ ê¸°ë¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
            <li>- í™•ì¸ì´ í•„ìš”í•œ ê²½ìš° 1:1 ë¬¸ì˜í•˜ê¸° ë˜ëŠ” ê³ ê°ì„¼í„° ì „í™”ë¡œ ë¬¸ì˜ ë¶€íƒë“œë¦½ë‹ˆë‹¤.</li>
          </ul>
          <button type="button" class="c_service_btn">1:1 ë¬¸ì˜í•˜ê¸°</button>
        </div>
        <div class="c_service_cont">
          <p>ë¬¸ì˜ ë‚´ì—­ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<footer th:replace="fragments/footer :: footerFragment"></footer>

<script src="/js/mypage.js"></script>
<script>
  // ì£¼ì†Œ ê²€ìƒ‰
  function execDaumPostcode() {
    new daum.Postcode({
      oncomplete: function (data) {
        console.log(data);
        document.getElementById('zipcode').value = data.zonecode;
        document.getElementById('address01').value = data.address;
        document.getElementById('address02').focus();
      }
    }).open();
  }

  const modifyInfoBtn = document.querySelector(".cus_edit"); //íšŒì› ì •ë³´ ìˆ˜ì • ë²„íŠ¼
  const deleteAccountBtn = document.querySelector(".cus_edit2"); //íšŒì› íƒˆí‡´ ë²„íŠ¼
  // íšŒì› ì •ë³´ ì¡°íšŒ
  function lookupMemberInfo() {
    fetch("/mypage/info", {
      method: "POST"
    })
            .then(response => response.json())
            .then(json => {
              const telNumbers = json.tel.replace(/-/g, '');
              const responseData = {
                userName: json.userName,
                userID: json.userID,
                userEmail: json.userEmail,
                userBirthdate: json.birthdate,
                userGender: json.gender,
                zipcode: json.zipcode,
                address01: json.address01,
                address02: json.address02,
                tel1: telNumbers.substring(0, 3),
                tel2: telNumbers.substring(3, 7),
                tel3: telNumbers.substring(7, 11),
              };
              console.log(responseData);

              Object.entries(responseData).forEach(([key, value]) => {
                if (key === "userGender") {
                  // ğŸ”½ ë¼ë””ì˜¤ ë²„íŠ¼ ì¤‘ valueê°€ ì¼ì¹˜í•˜ëŠ” ìš”ì†Œë¥¼ ì²´í¬
                  const radio = document.querySelector(`input[name="gender"][value="${value}"]`);
                  if (radio) radio.checked = true;
                  return;
                }

                const el = document.querySelector(`[data-field="${key}"]`);
                if (!el) return;

                if (el.tagName === "INPUT" || el.tagName === "SELECT" || el.tagName === "TEXTAREA") {
                  el.value = value;
                } else {
                  el.textContent = value;
                }
              });
              deleteAccountBtn.setAttribute("data-id", json.id);
            })
  }

  // í˜ì´ì§€ ë¡œë”©ì‹œ íšŒì›ì •ë³´ ì¡°íšŒ
  document.addEventListener('DOMContentLoaded', () => {
    lookupMemberInfo();
  });

  // íšŒì› ì •ë³´ ìˆ˜ì •
  modifyInfoBtn.addEventListener("click", (e) => {
    if (!confirm("ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const data = {};
    const inputFields = document.querySelectorAll('input[data-field], select[data-field]');

    inputFields.forEach(field => {
      const key = field.dataset.field;
      data[key] = field.value;
    });
    console.log(data)

    if (!/^\d{3,4}$/.test(data.tel2) || !/^\d{4}$/.test(data.tel3)) {
      alert("ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }

    data.tel = data.tel1 + "-" + data.tel2 + "-" + data.tel3;
    delete data.tel1;
    delete data.tel2;
    delete data.tel3;

    console.log(data);

    fetch("/mypage/modify", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    })
            .then(response => response.json())
            .then(json => {
              console.log("modify ë¶€ë¶„")
              console.log(json)
              if (json.isModify == "true") {
                alert("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                lookupMemberInfo();
                inputFields.forEach(field => {
                  field.value = "";
                });
              } else {
                alert(json.error);
              }
            })
  })

  // íšŒì› íƒˆí‡´
  deleteAccountBtn.addEventListener("click", (e) => {
    //íšŒì› íƒˆí‡´ë²„íŠ¼ í´ë¦­ì‹œ confirm
    if (confirm("ì •ë§ë¡œ íšŒì› íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      fetch("/mypage/delete/" + deleteAccountBtn.dataset.id)
              .then(response => response.json())
              .then(json => {
                if (json.isDelete == "true") {
                  alert("íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                  location.href = "/member/logout";
                }
              })
    } else {
      alert("íƒˆí‡´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
  })
</script>
<script>
  //ë°˜ë ¤ë™ë¬¼ ë“±ë¡
  /*document.getElementById("petSubmitBtn").addEventListener("click", function () {
    const formData = new FormData();
    formData.append("petName", document.getElementById("petName").value);
    formData.append("species", document.getElementById("species").value);
    formData.append("birthDate", document.getElementById("birthDate").value);
    formData.append("character", document.getElementById("character").value);
    formData.append("petLike", document.getElementById("petLike").value);
    formData.append("petDisLike", document.getElementById("petDisLike").value);
    formData.append("content", document.getElementById("content").value);

    // petGenderê°€ ì„ íƒëëŠ”ì§€ í™•ì¸
    const genderChecked = document.querySelector('input[name="petGender"]:checked');
    if (!genderChecked) {
      alert("ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    formData.append("petGender", genderChecked.value);

    const profileImgFile = document.getElementById("profileImg").files[0];
    if (profileImgFile) {
      formData.append("profileImg", profileImgFile);
    }

    fetch("/mypage/petreg", {
      method: "POST",
      body: formData
    }).then(res => {
      if (res.ok) {
        alert("ë°˜ë ¤ë™ë¬¼ ë“±ë¡ ì™„ë£Œ!");

        // ì…ë ¥í¼ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
        clearPetForm();

        // í˜¹ì‹œ ë“±ë¡ í›„ ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™ ì›í•˜ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
        // window.location.href = "/mypage";

      } else {
        alert("ë“±ë¡ ì‹¤íŒ¨!");
      }
    }).catch(err => {
      alert("ì—ëŸ¬ ë°œìƒ: " + err);
    });
  });

  // í¼ ì´ˆê¸°í™” í•¨ìˆ˜
  function clearPetForm() {
    document.getElementById('petName').value = '';
    document.getElementById('species').value = '';
    const checkedGender = document.querySelector('input[name="petGender"]:checked');
    if (checkedGender) checkedGender.checked = false;
    document.getElementById('birthDate').value = '';
    document.getElementById('character').value = '';
    document.getElementById('petLike').value = '';
    document.getElementById('petDisLike').value = '';
    document.getElementById('content').value = '';
    document.getElementById('profileImg').value = '';
  }*/
</script>
<script> //íŒ”ë¡œìš°í•œ ë°˜ë ¤ë™ë¬¼ ì‚­ì œì²˜ë¦¬
  document.addEventListener("DOMContentLoaded", function () {
    const unfollowButtons = document.querySelectorAll(".unfollow-btn");

    unfollowButtons.forEach(function (button) {
      button.addEventListener("click", function () {
        const petCard = this.closest(".pet-card");
        const petId = this.dataset.petId;

        // ì„ì‹œë¡œ í”„ë¡ íŠ¸ì—ì„œ ì œê±° (ì¶”í›„ ì„œë²„ì— AJAX ìš”ì²­ ê°€ëŠ¥)
        if (confirm("ì´ ë°˜ë ¤ë™ë¬¼ì˜ íŒ”ë¡œìš°ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          petCard.remove();
          // TODO: ì„œë²„ì— unfollow ìš”ì²­ ë³´ë‚´ê¸°
          console.log("íŒ”ë¡œìš° ì·¨ì†Œ: petId = " + petId);
        }
      });
    });
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab');

    document.querySelectorAll('.content').forEach(div => div.style.display = 'none');

    switch (activeTab) {
      case 'freeboard':
        document.querySelectorAll('.content')[2].style.display = 'block';
        break;
      case 'talent':
        document.querySelectorAll('.content')[1].style.display = 'block';
        break;
      case 'pet':
        document.querySelectorAll('.content')[3].style.display = 'block';
        break;
      case 'follow':
        document.querySelectorAll('.content')[4].style.display = 'block';
        break;
      case 'qna':
        document.querySelectorAll('.content')[5].style.display = 'block';
        break;
      default:
        document.getElementById('profile').style.display = 'block';
    }
  });
</script>
</body>
</html>