<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>ë§ˆì´í˜ì´ì§€</title>
    <th:block th:replace="fragments/head :: head('ë§ˆì´í˜ì´ì§€')"></th:block>
    <link rel="stylesheet" href="/css/mypage/mypage.css" />
    <meta charset="UTF-8" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body>
<div th:replace="~{fragments/header}"></div>

<!-- â†“â†“â†“ ì´í•˜ ê¸°ì¡´ ë§ˆì´í˜ì´ì§€ ì½˜í…ì¸  ìœ ì§€ â†“â†“â†“ -->
<div id="section">
            <!-- ë‚´ê°€ ì‘ì„±í•œ ê¸€ ë‚´ì—­ -->
            <div class="content" id="freeboard" style="display:none;">
                <h2>ë‚´ê°€ ì“´ ììœ ê²Œì‹œíŒ ê¸€</h2>
                <ul class="request_detail">
                    <li class="detail_on">ììœ ê²Œì‹œíŒ ê¸€ ë‚´ì—­(<span id="number1">1</span>)</li>
                </ul>
                <table class="order_table">
                    <thead>
                    <tr>
                        <th>ê¸€ì“´ë‚ ì§œ</th>
                        <th>ì œëª©</th>
                    </tr>
                    </thead>
                    <tbody id="subscribeRap">
                    <tr th:each="board : ${myBoards}">
                        <td th:text="${#temporals.format(board.modifyDate != null ? board.modifyDate : board.regDate, 'yyyy-MM-dd HH:mm')}"></td>
                        <td><a th:href="@{/community/boarddetail/{id}(id=${board.id})}" th:text="${board.subject}">ê²Œì‹œê¸€ ì œëª©</a></td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(myBoards)}">
                        <td colspan="3">ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                    </tbody>
                </table>

                <table class="page_btn">
                    <tbody>
                    <tr id="freeboard-pagination">
                        <td th:if="${myBoardsPage.hasPrevious()}">
                            <a href="#" class="page-link" th:attr="data-page=${myBoardsPage.number - 1}">ì´ì „</a>
                        </td>

                        <td th:each="pageNum : ${#numbers.sequence(0, myBoardsPage.totalPages - 1)}"
                            th:classappend="${pageNum == myBoardsPage.number} ? 'current'">
                            <a href="#" class="page-link" th:text="${pageNum + 1}" th:attr="data-page=${pageNum}">1</a>
                        </td>

                        <td th:if="${myBoardsPage.hasNext()}">
                            <a href="#" class="page-link" th:attr="data-page=${myBoardsPage.number + 1}">ë‹¤ìŒ</a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>


                <!--<table class="personal_info">
                  <tr><td>ì´ë¦„</td><td><input type="text" id="petName" name="petName"></td></tr>
                  <tr><td>ì¢…</td><td><input type="text" id="species" name="species"></td></tr>
                  <tr>
                    <td>ì„±ë³„</td>
                    <td>
                      <input type="radio" id="Male" name="petGender" value="MALE">
                      <label for="Male">ìˆ˜ì»·</label>
                      <input type="radio" id="Female" name="petGender" value="FEMALE">
                      <label for="Female">ì•”ì»·</label>
                    </td>
                  </tr>
                  <tr><td>ìƒë…„ì›”ì¼</td><td><input type="text" id="birthDate" name="birthDate"></td></tr>
                  <tr><td>ì„±ê²©</td><td><input type="text" id="character" name="character"></td></tr>
                  <tr><td>ì¢‹ì•„í•˜ëŠ” ê²ƒ</td><td><input type="text" id="petLike" name="petLike"></td></tr>
                  <tr><td>ì‹«ì–´í•˜ëŠ” ê²ƒ</td><td><input type="text" id="petDisLike" name="petDisLike"></td></tr>
                  <tr><td>ì†Œê°œ</td><td><textarea id="content" name="content"></textarea></td></tr>
                  <tr><td>í”„ë¡œí•„ ì´ë¯¸ì§€</td><td><input type="file" id="profileImg" name="profileImg"></td></tr>
                </table>
                <button class="cus_edit" id="petSubmitBtn" style="border-radius: 40px;">ë“±ë¡í•˜ê¸°</button>-->
            </div>

        </div>
    </div>
</div>

<div th:replace="~{fragments/footer}"></div>

<script src="/js/mypage.js"></script>
<script>
    // ì£¼ì†Œ ê²€ìƒ‰
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function (data) {
                console.log(data);
                document.getElementById('zipcode').value = data.zonecode;
                document.getElementById('address01').value = data.address;
                document.getElementById('address02').focus();
            }
        }).open();
    }

    const modifyInfoBtn = document.querySelector(".cus_edit"); //íšŒì› ì •ë³´ ìˆ˜ì • ë²„íŠ¼
    const deleteAccountBtn = document.querySelector(".cus_edit2"); //íšŒì› íƒˆí‡´ ë²„íŠ¼
    // íšŒì› ì •ë³´ ì¡°íšŒ
    function lookupMemberInfo() {
        fetch("/mypage/info", {
            method: "POST"
        })
            .then(response => response.json())
            .then(json => {
                const telNumbers = json.tel.replace(/-/g, '');
                const responseData = {
                    userName: json.userName,
                    userID: json.userID,
                    userEmail: json.userEmail,
                    userBirthdate: json.birthdate,
                    userGender: json.gender,
                    zipcode: json.zipcode,
                    address01: json.address01,
                    address02: json.address02,
                    tel1: telNumbers.substring(0, 3),
                    tel2: telNumbers.substring(3, 7),
                    tel3: telNumbers.substring(7, 11),
                };
                console.log(responseData);

                Object.entries(responseData).forEach(([key, value]) => {
                    if (key === "userGender") {
                        // ğŸ”½ ë¼ë””ì˜¤ ë²„íŠ¼ ì¤‘ valueê°€ ì¼ì¹˜í•˜ëŠ” ìš”ì†Œë¥¼ ì²´í¬
                        const radio = document.querySelector(`input[name="gender"][value="${value}"]`);
                        if (radio) radio.checked = true;
                        return;
                    }

                    const el = document.querySelector(`[data-field="${key}"]`);
                    if (!el) return;

                    if (el.tagName === "INPUT" || el.tagName === "SELECT" || el.tagName === "TEXTAREA") {
                        el.value = value;
                    } else {
                        el.textContent = value;
                    }
                });
                deleteAccountBtn.setAttribute("data-id", json.id);
            })
    }

    // í˜ì´ì§€ ë¡œë”©ì‹œ íšŒì›ì •ë³´ ì¡°íšŒ
    document.addEventListener('DOMContentLoaded', () => {
        lookupMemberInfo();
    });

    // íšŒì› ì •ë³´ ìˆ˜ì •
    modifyInfoBtn.addEventListener("click", (e) => {
        if (!confirm("ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const data = {};
        const inputFields = document.querySelectorAll('input[data-field], select[data-field]');

        inputFields.forEach(field => {
            const key = field.dataset.field;
            data[key] = field.value;
        });
        console.log(data)

        if (!/^\d{3,4}$/.test(data.tel2) || !/^\d{4}$/.test(data.tel3)) {
            alert("ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        data.tel = data.tel1 + "-" + data.tel2 + "-" + data.tel3;
        delete data.tel1;
        delete data.tel2;
        delete data.tel3;

        console.log(data);

        fetch("/mypage/modify", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(json => {
                console.log("modify ë¶€ë¶„")
                console.log(json)
                if (json.isModify == "true") {
                    alert("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    lookupMemberInfo();
                    inputFields.forEach(field => {
                        field.value = "";
                    });
                } else {
                    alert(json.error);
                }
            })
    })

    // íšŒì› íƒˆí‡´
    deleteAccountBtn.addEventListener("click", (e) => {
        //íšŒì› íƒˆí‡´ë²„íŠ¼ í´ë¦­ì‹œ confirm
        if (confirm("ì •ë§ë¡œ íšŒì› íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            fetch("/mypage/delete/" + deleteAccountBtn.dataset.id)
                .then(response => response.json())
                .then(json => {
                    if (json.isDelete == "true") {
                        alert("íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        location.href = "/member/logout";
                    }
                })
        } else {
            alert("íƒˆí‡´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    })
</script>
<script>
    //ë°˜ë ¤ë™ë¬¼ ë“±ë¡
    /*document.getElementById("petSubmitBtn").addEventListener("click", function () {
      const formData = new FormData();
      formData.append("petName", document.getElementById("petName").value);
      formData.append("species", document.getElementById("species").value);
      formData.append("birthDate", document.getElementById("birthDate").value);
      formData.append("character", document.getElementById("character").value);
      formData.append("petLike", document.getElementById("petLike").value);
      formData.append("petDisLike", document.getElementById("petDisLike").value);
      formData.append("content", document.getElementById("content").value);

      // petGenderê°€ ì„ íƒëëŠ”ì§€ í™•ì¸
      const genderChecked = document.querySelector('input[name="petGender"]:checked');
      if (!genderChecked) {
        alert("ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      formData.append("petGender", genderChecked.value);

      const profileImgFile = document.getElementById("profileImg").files[0];
      if (profileImgFile) {
        formData.append("profileImg", profileImgFile);
      }

      fetch("/mypage/petreg", {
        method: "POST",
        body: formData
      }).then(res => {
        if (res.ok) {
          alert("ë°˜ë ¤ë™ë¬¼ ë“±ë¡ ì™„ë£Œ!");

          // ì…ë ¥í¼ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
          clearPetForm();

          // í˜¹ì‹œ ë“±ë¡ í›„ ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™ ì›í•˜ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
          // window.location.href = "/mypage";

        } else {
          alert("ë“±ë¡ ì‹¤íŒ¨!");
        }
      }).catch(err => {
        alert("ì—ëŸ¬ ë°œìƒ: " + err);
      });
    });

    // í¼ ì´ˆê¸°í™” í•¨ìˆ˜
    function clearPetForm() {
      document.getElementById('petName').value = '';
      document.getElementById('species').value = '';
      const checkedGender = document.querySelector('input[name="petGender"]:checked');
      if (checkedGender) checkedGender.checked = false;
      document.getElementById('birthDate').value = '';
      document.getElementById('character').value = '';
      document.getElementById('petLike').value = '';
      document.getElementById('petDisLike').value = '';
      document.getElementById('content').value = '';
      document.getElementById('profileImg').value = '';
    }*/
</script>
<script> //íŒ”ë¡œìš°í•œ ë°˜ë ¤ë™ë¬¼ ì‚­ì œì²˜ë¦¬
document.addEventListener("DOMContentLoaded", function () {
    const unfollowButtons = document.querySelectorAll(".unfollow-btn");

    unfollowButtons.forEach(function (button) {
        button.addEventListener("click", function () {
            const petCard = this.closest(".pet-card");
            const petId = this.dataset.petId;

            // ì„ì‹œë¡œ í”„ë¡ íŠ¸ì—ì„œ ì œê±° (ì¶”í›„ ì„œë²„ì— AJAX ìš”ì²­ ê°€ëŠ¥)
            if (confirm("ì´ ë°˜ë ¤ë™ë¬¼ì˜ íŒ”ë¡œìš°ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                petCard.remove();
                // TODO: ì„œë²„ì— unfollow ìš”ì²­ ë³´ë‚´ê¸°
                console.log("íŒ”ë¡œìš° ì·¨ì†Œ: petId = " + petId);
            }
        });
    });
});
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');

        document.querySelectorAll('.content').forEach(div => div.style.display = 'none');

        switch (activeTab) {
            case 'freeboard':
                document.querySelectorAll('.content')[2].style.display = 'block';
                break;
            case 'talent':
                document.querySelectorAll('.content')[1].style.display = 'block';
                break;
            case 'pet':
                document.querySelectorAll('.content')[3].style.display = 'block';
                break;
            case 'follow':
                document.querySelectorAll('.content')[4].style.display = 'block';
                break;
            case 'qna':
                document.querySelectorAll('.content')[5].style.display = 'block';
                break;
            default:
                document.getElementById('profile').style.display = 'block';
        }
    });
</script>
<script>
    function loadFreeboardPage(pageNum = 0) {
        fetch(`/mypage/myboards?page=${pageNum}`)
            .then(res => res.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                const newBody = doc.querySelector('#subscribeRap');
                const newPagination = doc.querySelector('#freeboard-pagination');

                if (newBody) {
                    document.getElementById('subscribeRap').innerHTML = newBody.innerHTML;
                }
                if (newPagination) {
                    document.getElementById('freeboard-pagination').innerHTML = newPagination.innerHTML;
                }

                attachPageEvent(); // í˜ì´ì§€ë„¤ì´ì…˜ì— ë‹¤ì‹œ ì´ë²¤íŠ¸ ë¶€ì°©
            });
    }

    function attachPageEvent() {
        document.querySelectorAll('#freeboard-pagination .page-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const page = this.dataset.page;
                loadFreeboardPage(page);
            });
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');

        if (activeTab === 'freeboard') {
            loadFreeboardPage(); // íƒ­ ì—´ë¦´ ë•Œ ì²« í˜ì´ì§€ ë¡œë”©
        }

        // íƒ­ ì „í™˜ ì‹œì—ë„ ë¶ˆëŸ¬ì˜¤ë„ë¡ (ì˜µì…˜)
        document.querySelector('[data-tab="freeboard"]')?.addEventListener('click', function () {
            loadFreeboardPage();
        });
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tabMenuItems = document.querySelectorAll(".list1 li");
        const contentDivs = document.querySelectorAll(".content");

        tabMenuItems.forEach(item => {
            item.addEventListener("click", function () {
                const tab = this.getAttribute("data-tab");

                // ëª¨ë“  content ìˆ¨ê¸°ê¸°
                contentDivs.forEach(div => {
                    div.style.display = "none";
                });

                // í•´ë‹¹ íƒ­ì— ë§ëŠ” content ë³´ì—¬ì£¼ê¸°
                if (tab === "freeboard") {
                    document.querySelector("#freeboard").style.display = "block";
                    loadFreeboardPage(); // í˜ì´ì§€ ì „í™˜ ì‹œ ë°ì´í„° ë¡œë”©
                } else if (tab === "profile") {
                    document.querySelector("#profile").style.display = "block";
                } else if (tab === "talent") {
                    contentDivs[1].style.display = "block";
                } else if (tab === "pet") {
                    contentDivs[3].style.display = "block";
                } else if (tab === "follow") {
                    contentDivs[4].style.display = "block";
                } else if (tab === "qna") {
                    contentDivs[5].style.display = "block";
                }

                // URLë„ ì—…ë°ì´íŠ¸ (ì„ íƒ ì‚¬í•­)
                const newUrl = `${window.location.pathname}?tab=${tab}`;
                window.history.pushState({}, '', newUrl);
            });
        });
    });
</script>
</body>
</html>